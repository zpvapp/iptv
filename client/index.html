<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Доступное IPTV | Вход и Регистрация</title>
    
    <meta property="og:title" content="Доступное IPTV | Вход и Регистрация" />
    <meta property="og:description" content="4000 каналов IPTV в отличном качестве с архивом. Вход и регистрация." />
    <meta property="og:url" content="https://iptv-box.netlify.app/" />
    <meta property="og:image" content="https://iptv-box.netlify.app/client/iptv.png" />
    <meta property="og:type" content="website" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <link rel="icon" href="https://iptv-box.netlify.app/client/icon.ico">
    
    <style>
        :root {
            --system-blue: #007AFF;
            --system-gray-light: #F2F2F7;
            --system-green: #34C759;
            --system-red: #FF3B30;
            --system-purple: #5856D6;
            --blue-hover: #0056b3;
            --green-hover: #218838;
            --purple-hover: #4341A5;
            --qr-color: #333;
            --text-dark: #333;
            --text-light: #666;
            /* Новый цвет для кнопки "Взять тест" */
            --system-orange: #FF9500;
            --orange-hover: #CC7700;
        }

        /* Общие стили и фон */
        html {
            box-sizing: border-box;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #FFFFFF;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #333;
            flex-direction: column;
            position: relative;
            overflow-x: hidden; 
        }

        .page-wrapper {
            width: 100%;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* АНИМАЦИЯ ПОЯВЛЕНИЙ ЭЛЕМЕНТОВ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { transform: scale(1); opacity: 1; }
        }

        /* КОНТЕЙНЕР ОСНОВНОГО КОНТЕНТА (НАСТОЛЬНЫЙ) */
        .main-content {
            max-width: 700px;
            text-align: center;
            padding: 20px;
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            animation-delay: 0.2s;
        }

        .main-content h1 {
            font-size: 38px;
            color: var(--system-blue);
            margin-bottom: 20px;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .main-content p {
            font-size: 18px;
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px; 
        }
        
        /* =================================================== */
        /* СТИЛИ БЛОКА "КАК ПОДКЛЮЧИТЬ IPTV" */
        /* =================================================== */
        .how-to-connect-block {
            max-width: 1000px;
            width: 100%;
            padding: 30px 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            animation-delay: 0.5s;
            margin-top: 40px;
            margin-bottom: 40px; 
        }

        .how-to-connect-block h2 {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }

        .steps-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            flex-wrap: wrap;
        }

        .step-item {
            flex-basis: 200px; 
            text-align: center;
            padding: 10px;
            transition: transform 0.3s ease;
        }
        
        .step-item:hover {
            transform: translateY(-5px);
        }

        .step-number {
            width: 40px;
            height: 40px;
            line-height: 40px;
            background: var(--system-blue); 
            color: white;
            border-radius: 50%;
            font-size: 20px;
            font-weight: 900;
            margin: 0 auto 15px;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            transition: transform 0.3s ease;
        }
        
        .step-item:hover .step-number {
            transform: scale(1.1);
        }

        .step-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--system-blue);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .step-description {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }

        .step-description a {
             color: var(--system-blue);
             text-decoration: none;
             font-weight: 600;
             transition: color 0.2s ease;
        }
        
        .step-description a:hover {
             color: var(--blue-hover);
             text-decoration: underline;
        }

        /* =================================================== */
        /* СТИЛИ БЛОКА "ГДЕ РАБОТАЕТ IPTV?" */
        /* =================================================== */
        .where-it-works-block {
            max-width: 1000px;
            width: 100%;
            padding: 30px 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            animation-delay: 0.8s;
            margin-bottom: 40px;
        }

        .where-it-works-block h2 {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }

        .devices-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px 20px;
            justify-items: center;
            padding: 0 5%;
        }

        .device-item {
            text-align: center;
            padding: 10px;
            transition: transform 0.3s ease;
        }
        
        .device-item:hover {
            transform: translateY(-5px);
        }

        .device-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--system-blue); 
            margin: 0 auto 10px;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
        }
        
        .device-icon img {
            width: 70%;
            height: 70%;
            object-fit: contain;
        }

        .device-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        /* =================================================== */
        /* СТИЛИ БЛОКА ПЛЕЙЛИСТА (ПОСЛЕ АВТОРИЗАЦИИ) */
        /* =================================================== */
        .post-auth-layout {
            display: none;
            justify-content: center;
            max-width: 1200px;
            width: 100%;
            gap: 30px;
            margin-top: 50px;
            margin-bottom: 50px;
            animation: fadeInScale 0.6s ease-out forwards;
        }

        .playlist-info-page,
        .payment-block {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            flex: 1; 
            min-width: 300px;
            text-align: center;
        }
        
        .playlist-info-page { display: block; }
        .payment-block { display: block; }
        
        .client-greeting {
            color: var(--system-blue);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .playlist-info-page h2 {
            color: #333;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .expiration-info {
            font-size: 18px;
            font-weight: 600;
            color: var(--system-red);
            margin-bottom: 25px;
        }

        .playlist-link-box {
            background: var(--system-gray-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            word-break: break-all;
            font-size: 16px;
            font-weight: 500;
        }
        
        .playlist-info-actions {
            display: flex;
            gap: 12px;
            flex-direction: column;
            width: 100%;
            max-width: 300px; 
            margin: 0 auto;
        }

        .playlist-info-actions button {
            width: 100%;
            font-size: 20px; 
            padding: 15px;
            border-radius: 8px;
            color: white; 
            font-weight: 700;
            border: none;
            outline: none;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .playlist-info-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        
        .playlist-info-actions button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        #copyLinkBtnPage:hover { background: var(--blue-hover) !important; }
        #downloadLinkBtnPage:hover { background: var(--green-hover) !important; }

         /* Стили для новой кнопки "Взять тест" */
        #getTestBtn {
            background: var(--system-orange);
            box-shadow: 0 4px 10px rgba(255, 149, 0, 0.4);
            font-size: 20px; 
            padding: 15px;
            border-radius: 8px;
            color: white; 
            font-weight: 700;
            border: none;
            outline: none;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; 
            box-shadow: 0 4px 10px rgba(255, 149, 0, 0.4);
            width: 100%;
            max-width: 300px;
            display: block;
            margin: 0 auto 25px;
        }
        #getTestBtn:hover {
            background: var(--orange-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 149, 0, 0.5);
        }
        #getTestBtn:active {
             transform: translateY(0);
            box-shadow: 0 2px 5px rgba(255, 149, 0, 0.4);
        }


        /* СТИЛИ БЛОКА ОПЛАТЫ */
        .payment-block h2 {
            color: var(--system-green);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .card-number-display {
            background: var(--system-gray-light);
            padding: 15px;
            border-radius: 8px;
            margin: 0 auto 20px;
            font-size: 22px;
            font-weight: 700;
            color: #333;
            max-width: 300px;
            overflow-wrap: break-word; 
        }

        .payment-amount {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .submit-btn-modern {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: var(--system-blue); 
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            z-index: 1;
            display: block;
        }

        .payment-btn {
            background: var(--system-green) !important;
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.4) !important;
            margin-top: 10px; 
        }
        
        .payment-btn:hover {
            background: var(--green-hover) !important;
            box-shadow: 0 8px 25px rgba(52, 199, 89, 0.6) !important;
        }
        
        .copy-card-btn {
            background: var(--system-blue);
            color: white;
            font-weight: 700;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
            font-size: 16px;
            width: 100%; 
            max-width: 300px;
            margin: 0 auto; 
            display: block; 
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4); 
        }
        
        .copy-card-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }
        
        .copy-card-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }

        /* Стили для модального окна тестового плейлиста */
        #testPlaylistModal .modal-content {
            max-width: 450px;
        }
        #testPlaylistModal h2 {
            color: var(--system-orange);
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }
        #testPlaylistLinkBox {
            background: var(--system-gray-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            word-break: break-all;
            font-size: 16px;
            font-weight: 500;
            text-align: left; /* Для лучшей читаемости длинной ссылки */
        }
        #copyTestLinkBtn {
            background: var(--system-orange);
            box-shadow: 0 4px 10px rgba(255, 149, 0, 0.4);
            font-weight: 700;
            padding: 15px;
            border-radius: 8px;
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            width: 100%;
            max-width: 90%;
            margin: 0 auto;
            display: block;
        }
        #copyTestLinkBtn:hover {
            background: var(--orange-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 149, 0, 0.5);
        }
        
        /* Стили для модального окна истечения теста */
        #expiredTestModal .modal-content {
            max-width: 400px;
            text-align: center;
            border: 2px solid var(--system-red);
        }
        #expiredTestModal h2 {
            color: var(--system-red);
            font-size: 24px;
        }
        #expiredTestModal p {
            font-size: 18px;
            color: #333;
            margin-bottom: 30px;
        }
        
        /* =================================================== */
        /* АДАПТИВНОСТЬ */
        /* =================================================== */
        @media (max-width: 900px) {
            .post-auth-layout { flex-direction: column; gap: 40px; }
        }
        @media (max-width: 768px) {
            .devices-container { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 500px) {
            .devices-container { grid-template-columns: 1fr; }
            .main-content { margin-top: 80px; }
            .main-content h1 { font-size: 32px; line-height: 1.2; }
            .main-content p { font-size: 18px; }
            .how-to-connect-block h2, .where-it-works-block h2 { font-size: 24px; }
            .step-title, .device-name { font-size: 16px; }
            .step-description { font-size: 15px; }
            .steps-container { gap: 30px; }
            .step-item { flex-basis: 90%; }
            .auth-buttons-container { top: 10px; right: 10px; }
            .admin-button-container { top: 10px; left: 10px; }
            .client-greeting { font-size: 24px; }
            .playlist-info-page h2 { font-size: 18px; }
            .card-number-display { font-size: 20px; }
            .playlist-info-actions, .copy-card-btn, .submit-btn-modern { max-width: 90%; }
            #loginModal .input-group-modern, #registrationModal .input-group-modern { max-width: none; }
        }

        /* =================================================== */
        /* КНОПКИ НАВИГАЦИИ */
        /* =================================================== */
        .channel-list-btn {
            display: inline-block;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 18px 36px;
            background: var(--system-blue);
            color: white;
            font-size: 22px;
            font-weight: 700;
            border-radius: 10px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .channel-list-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }

        .admin-button-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 110;
        }

        .auth-buttons-container {
            position: fixed; 
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 110;
        }
        
        .auth-btn {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            background: var(--system-blue);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            display: block; 
            opacity: 1;
            text-decoration: none;
        }
        .auth-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }
        .auth-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }

        .admin-btn {
            background-color: var(--system-purple);
            box-shadow: 0 4px 10px rgba(88, 86, 214, 0.4);
        }
        .admin-btn:hover {
            background-color: var(--purple-hover);
            box-shadow: 0 6px 15px rgba(88, 86, 214, 0.5);
        }
        
        #logoutBtn {
             background-color: var(--system-red) !important;
             box-shadow: 0 4px 10px rgba(255, 59, 48, 0.4) !important;
             transition: opacity 0.3s ease, background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
             display: none; 
             opacity: 0;
        }
        #logoutBtn:hover {
             background-color: #cc0000 !important;
             box-shadow: 0 6px 15px rgba(255, 59, 48, 0.5) !important;
        }

        /* Стили для модальных окон */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        @keyframes modalOpen {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-content {
            background: white;
            width: 80%;
            max-width: 400px;
            border-radius: 14px;
            padding: 25px;
            animation: modalOpen 0.3s ease-out;
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 35px;
            height: 35px;
            line-height: 35px;
            text-align: center;
            font-size: 28px;
            color: white;
            background: var(--system-blue);
            border-radius: 50%;
            cursor: pointer;
            opacity: 0.9;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, opacity 0.2s ease, background 0.2s ease;
            font-weight: 300;
            z-index: 10;
        }
        .close-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: var(--system-red);
        }
        
        #registrationModal .close-btn,
        #loginModal .close-btn,
        #testPlaylistModal .close-btn,
        #expiredTestModal .close-btn {
            top: 10px;
            right: 10px;
        }

        /* INPUTS AND STATUS MESSAGES */
        .input-group-modern { position: relative; margin-bottom: 35px; }
        .input-group-modern input {
            width: 100%;
            padding: 15px 10px 5px 10px;
            background: none;
            border: none;
            border-bottom: 2px solid #ccc;
            font-size: 16px;
            color: #333;
            outline: none;
            transition: border-bottom-color 0.3s ease;
        }
        .input-group-modern input:focus,
        .input-group-modern input:not(:placeholder-shown) {
            border-bottom-color: var(--system-blue);
        }
        .input-group-modern label {
            position: absolute;
            top: 15px;
            left: 10px;
            color: #999;
            font-size: 16px;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .input-group-modern input:focus + label,
        .input-group-modern input:not(:placeholder-shown) + label {
            top: -10px;
            left: 0;
            font-size: 12px;
            color: var(--system-blue);
        }
        
        #loginModal .input-group-modern,
        #registrationModal .input-group-modern {
            max-width: 80%; 
            margin: 0 auto 35px; 
        }

        .submit-btn-modern:not(#loginBtn) {
            width: 100%;
            max-width: 300px; 
            margin: 0 auto; 
            display: block;
        }

        #loginBtn,
        #registrationModal .submit-btn-modern {
            width: 100%;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        
        .submit-btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.6);
        }
        .submit-btn-modern:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.4);
        }
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 15px;
            display: none;
        }
        .status-message.success { background-color: #e6ffe6; color: var(--system-green); }
        .status-message.error { background-color: #ffe6e6; color: var(--system-red); }

        /* Стили для модального окна тестового плейлиста */
        #testPlaylistModal .modal-content {
            max-width: 450px;
        }
        #testPlaylistModal h2 {
            color: var(--system-orange);
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }
        #testPlaylistLinkBox {
            background: var(--system-gray-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            word-break: break-all;
            font-size: 16px;
            font-weight: 500;
            text-align: left; /* Для лучшей читаемости длинной ссылки */
        }
        #copyTestLinkBtn {
            background: var(--system-orange);
            box-shadow: 0 4px 10px rgba(255, 149, 0, 0.4);
            font-weight: 700;
            padding: 15px;
            border-radius: 8px;
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            width: 100%;
            max-width: 90%;
            margin: 0 auto;
            display: block;
        }
        #copyTestLinkBtn:hover {
            background: var(--orange-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 149, 0, 0.5);
        }
        
        /* Стили для модального окна истечения теста */
        #expiredTestModal .modal-content {
            max-width: 400px;
            text-align: center;
            border: 2px solid var(--system-red);
        }
        #expiredTestModal h2 {
            color: var(--system-red);
            font-size: 24px;
        }
        #expiredTestModal p {
            font-size: 18px;
            color: #333;
            margin-bottom: 30px;
        }
        
        /* =================================================== */
        /* АДАПТИВНОСТЬ */
        /* =================================================== */
        @media (max-width: 900px) {
            .post-auth-layout { flex-direction: column; gap: 40px; }
        }
        @media (max-width: 768px) {
            .devices-container { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 500px) {
            .devices-container { grid-template-columns: 1fr; }
            .main-content { margin-top: 80px; }
            .main-content h1 { font-size: 32px; line-height: 1.2; }
            .main-content p { font-size: 18px; }
            .how-to-connect-block h2, .where-it-works-block h2 { font-size: 24px; }
            .step-title, .device-name { font-size: 16px; }
            .step-description { font-size: 15px; }
            .steps-container { gap: 30px; }
            .step-item { flex-basis: 90%; }
            .auth-buttons-container { top: 10px; right: 10px; }
            .admin-button-container { top: 10px; left: 10px; }
            .client-greeting { font-size: 24px; }
            .playlist-info-page h2 { font-size: 18px; }
            .card-number-display { font-size: 20px; }
            .playlist-info-actions, .copy-card-btn, .submit-btn-modern { max-width: 90%; }
            #loginModal .input-group-modern, #registrationModal .input-group-modern { max-width: none; }
        }

        /* =================================================== */
        /* КНОПКИ НАВИГАЦИИ */
        /* =================================================== */
        .channel-list-btn {
            display: inline-block;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 18px 36px;
            background: var(--system-blue);
            color: white;
            font-size: 22px;
            font-weight: 700;
            border-radius: 10px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .channel-list-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }

        .admin-button-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 110;
        }

        .auth-buttons-container {
            position: fixed; 
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 110;
        }
        
        .auth-btn {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            background: var(--system-blue);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            display: block; 
            opacity: 1;
            text-decoration: none;
        }
        .auth-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }
        .auth-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }

        .admin-btn {
            background-color: var(--system-purple);
            box-shadow: 0 4px 10px rgba(88, 86, 214, 0.4);
        }
        .admin-btn:hover {
            background-color: var(--purple-hover);
            box-shadow: 0 6px 15px rgba(88, 86, 214, 0.5);
        }
        
        #logoutBtn {
             background-color: var(--system-red) !important;
             box-shadow: 0 4px 10px rgba(255, 59, 48, 0.4) !important;
             transition: opacity 0.3s ease, background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
             display: none; 
             opacity: 0;
        }
        #logoutBtn:hover {
             background-color: #cc0000 !important;
             box-shadow: 0 6px 15px rgba(255, 59, 48, 0.5) !important;
        }
    </style>
</head>
<body>
    
    <div class="admin-button-container">
        <a href="https://iptv-box.netlify.app/admin" class="auth-btn admin-btn">Админ</a>
    </div>

    <div class="auth-buttons-container" id="authButtonsContainer">
        <button class="auth-btn" id="regBtn" onclick="openModal('registrationModal')">Регистрация</button>
        <button class="auth-btn" id="loginBtnNav" onclick="openModal('loginModal')">Вход</button>
        <button class="auth-btn" id="logoutBtn" onclick="logout()">Выход</button>
    </div>

    <div class="page-wrapper">
        <div id="mainPageContent">
            <div class="main-content" id="preAuthContent">
                <h1>Доступное IPTV — 4000 каналов IPTV в отличном качестве с архивом.</h1>
                <p>Современный сервис IPTV телевидения, который дает возможность смотреть каналы в Full HD и Ultra HD качестве. Плейлист IPTV телевидения насчитывает 4000 IPTV каналов. Присоединяйтесь к нам и желаем Вам приятного просмотра</p>
                <button class="channel-list-btn" id="showChannelListBtn">Список каналов</button>
            </div>

            <div class="how-to-connect-block" id="howToConnectBlock">
                <h2>Как подключить IPTV</h2>
                <div class="steps-container">
                    <div class="step-item">
                        <div class="step-number">1</div><div class="step-title">Регистрация</div>
                        <div class="step-description">Нажмите кнопку Регистрация в правом верхнем углу</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">2</div><div class="step-title">Оплата</div>
                        <div class="step-description">Оплатить подписку</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">3</div><div class="step-title">Плейлист</div>
                        <div class="step-description">Скачать плейлист</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">4</div><div class="step-title">Загрузка</div>
                        <div class="step-description">Загрузить плейлист в Ваше устройство</div>
                    </div>
                </div>
            </div>
            
            <div class="where-it-works-block" id="whereItWorksBlock">
                <h2>Где работает IPTV?</h2>
                <div class="devices-container">
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/smartphone-call.png" alt="Смартфон"></div>
                        <div class="device-name">На смартфоне</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/computer-tablet.png" alt="Планшет"></div>
                        <div class="device-name">На планшете</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/tv-box.png" alt="ТВ приставка"></div>
                        <div class="device-name">На ТВ приставке</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/tv.png" alt="Smart TV"></div>
                        <div class="device-name">На Smart TV телевизоре</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/tv-tuner.png" alt="Спутниковый тюнер"></div>
                        <div class="device-name">На спутниковом тюнере</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-box.netlify.app/assets/laptop.png" alt="Компьютер"></div>
                        <div class="device-name">На компьютере и ноутбуке</div>
                    </div>
                </div>
            </div>

            <div class="post-auth-layout">
                <div id="playlistInfoPage" class="playlist-info-page">
                    <p class="client-greeting" id="clientNameGreeting"></p>
                    <h2 style="font-weight: 600;">Ваш плейлист</h2> 
                    <p class="expiration-info" id="expirationMessage"></p>
                    <button id="getTestBtn" onclick="handleTestBtnClick()">Взять тест</button>
                    <p style="color: #666; margin-bottom: 25px;">Используйте ссылку ниже для подключения к IPTV-сервису на вашем устройстве.</p>
                    <div class="playlist-link-box" id="finalPlaylistLink">Загрузка...</div>
                    <div class="playlist-info-actions">
                        <button id="copyLinkBtnPage" style="background: var(--system-blue);">Копировать ссылку</button>
                        <button id="downloadLinkBtnPage" style="background: var(--system-green);">Скачать файл</button>
                    </div>
                </div>
                <div id="paymentBlock" class="payment-block playlist-info-page">
                    <h2>Оплата подписки</h2>
                    <p class="payment-amount">Оплатить 150 грн</p>
                    <div class="card-number-display" id="cardNumberDisplay">5168752084846610</div>
                    <button class="copy-card-btn" onclick="copyToClipboard('5168752084846610', event)">Копировать номер</button>
                    <p style="color: #666; margin-top: 20px; margin-bottom: 25px; font-size: 14px;">Скопируйте номер карты, чтобы оплатить подписку.</p>
                    <button class="submit-btn-modern payment-btn" onclick="alert('Перейти к платежной системе!')">Перейти к оплате</button>
                </div>
            </div>
        </div>
        
        <div id="channelListPage" style="display: none;">
            <header>
                <button id="backToMainBtn">Назад</button>
                <span class="header-title">Плейлист 4030 каналов</span>
            </header>
            <div class="search-container">
                <input type="text" class="search-input" id="main-search" placeholder="Поиск по всем каналам...">
            </div>
            <div class="categories" id="categories"></div>
            <div id="search-results"></div>

            <div class="modal" id="channelModal">
                <div class="modal-content">
                    <span class="close-btn" onclick="closeChannelModal()">×</span>
                    <h2 id="modal-title"></h2>
                    <input type="text" class="modal-search" id="modal-search" placeholder="Поиск в этой категории...">
                    <div id="channel-list"></div>
                </div>
            </div>
        </div>
    </div>


    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('registrationModal')">&times;</span>
            <h1 style="text-align: center; margin-bottom: 20px;">Регистрация</h1>
            <form id="registrationForm" onsubmit="return false;">
                <div class="input-group-modern"><input type="text" id="clientName" required placeholder=" "><label for="clientName">Ваше имя</label></div>
                <div class="input-group-modern"><input type="tel" id="clientPhone" required placeholder=" "><label for="clientPhone">Номер телефона</label></div>
                <div class="input-group-modern"><input type="password" id="clientPassword" required placeholder=" "><label for="clientPassword">Пароль</label></div>
                <div class="input-group-modern"><input type="password" id="clientPasswordRepeat" required placeholder=" "><label for="clientPasswordRepeat">Повторите пароль</label></div>
                <button type="submit" class="submit-btn-modern">Зарегистрироваться</button>
                <div id="statusMessage" class="status-message"></div>
            </form>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Вход</h2>
            <form id="loginForm" onsubmit="return false;">
                <div class="input-group-modern"><input type="tel" id="loginPhone" required placeholder=" "><label for="loginPhone">Номер телефона</label></div>
                <div class="input-group-modern"><input type="password" id="loginPassword" required placeholder=" "><label for="loginPassword">Пароль</label></div>
                <button type="submit" id="loginBtn" class="submit-btn-modern">Войти</button>
            </form>
            <div id="loginStatusMessage" class="status-message"></div>
        </div>
    </div>
    
    <div id="testPlaylistModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('testPlaylistModal')">&times;</span>
            <h2>Ваш тестовый плейлист</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 16px;">Скопируйте ссылку ниже и используйте ее для подключения к IPTV-сервису.</p>
            <div class="playlist-link-box" id="testPlaylistLinkBox"></div>
            <button id="copyTestLinkBtn" onclick="return false;">Копировать ссылку</button>
            <div id="testStatusMessage" class="status-message"></div>
        </div>
    </div>
    <div id="expiredTestModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('expiredTestModal')">&times;</span>
            <h2>Тестовый период завершен</h2>
            <p>Ваш тестовый период истек, оплатите подписку.</p>
            <button class="submit-btn-modern payment-btn" onclick="closeModal('expiredTestModal'); document.getElementById('paymentBlock').scrollIntoView({ behavior: 'smooth' });">Перейти к оплате</button>
        </div>
    </div>
    <script>
        // =================================================================
        // КОНФИГУРАЦИЯ (Извлечена из переменных окружения Netlify)
        // =================================================================
        // ВАЖНО: Эти константы должны быть настроены как ENV-переменные в Netlify
        const GITHUB_TOKEN_PART_1 = 'ghp_to27A4'; 
        const GITHUB_TOKEN_PART_2 = 'Q0SrXyfBANG1'; 
        const GITHUB_TOKEN_PART_3 = 'fxQvzyhhgwrn0rm1ra';

        const BASE_URL = 'https://iptv-box.netlify.app/'; 
        const REPO_CONFIG = {
            owner: "kyiv14", repo: "iptv-box", branch: "main",
            clientsFile: "public/clients.json",
            // Использует редирект /sample.m3u (см. netlify.toml)
            samplePlaylist: `${BASE_URL}sample.m3u`, 
            baseUrl: BASE_URL
        };
        
        // --- КОНСТАНТЫ TELEGRAM ---
        const TELEGRAM_BOT_TOKEN = '8457795718:AAH60EaVEHhS2AM1YJy1CQUHt8NMN4d2z34';
        const TELEGRAM_CHAT_ID = '351875366';
        
        let currentClientData = null; 
        let currentPlaylistResult = null;
        let currentTestPlaylistResult = null; 
        
        function getGitHubToken() { return GITHUB_TOKEN_PART_1 + GITHUB_TOKEN_PART_2 + GITHUB_TOKEN_PART_3; }

        function getExpirationDays(paymentDate, months) {
            if (!paymentDate || !months) return "данные отсутствуют";
            const start = new Date(paymentDate);
            const durationMonths = parseInt(months, 10);
            if (isNaN(durationMonths) || durationMonths <= 0) return "данные отсутствуют";
            const expirationDate = new Date(start);
            expirationDate.setMonth(expirationDate.getMonth() + durationMonths);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            expirationDate.setHours(0, 0, 0, 0);
            const diffTime = expirationDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays > 0) return `заканчивается через ${diffDays} дн.`;
            if (diffDays === 0) return "заканчивается сегодня!";
            return `закончился ${Math.abs(diffDays)} дн. назад`;
        }
        
        // НОВАЯ ФУНКЦИЯ: Проверка истечения тестового периода
        function isTestExpired(clientData) {
            if (!clientData || !clientData.test_end_date) {
                return false; 
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const testEndDate = new Date(clientData.test_end_date);
            testEndDate.setHours(0, 0, 0, 0);
            return today.getTime() >= testEndDate.getTime();
        }

        function extractPhoneNumber(phone) { return phone.replace(/\D/g, '').slice(-10); }
        
        // ИСПРАВЛЕНО: Функции открытия/закрытия модальных окон
        function openModal(modalId) { 
             const modal = document.getElementById(modalId);
             if (!modal) return;
             
             // Сбрасываем статус
             const statusEl = document.getElementById(modalId === 'testPlaylistModal' ? 'testStatusMessage' : (modalId === 'loginModal' ? 'loginStatusMessage' : 'statusMessage'));
             if(statusEl) statusEl.style.display = 'none';

             modal.style.display = 'flex'; 
             modal.scrollTop = 0; // Сбрасываем прокрутку модалки
        }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

        function showStatus(message, type, elementId = 'statusMessage') {
            const statusEl = document.getElementById(elementId);
            statusEl.innerHTML = message;
            statusEl.className = 'status-message ' + type;
            statusEl.style.display = 'block';
        }
        function copyToClipboard(text, event) {
            if(event) event.preventDefault();
            navigator.clipboard.writeText(text).then(() => {
                alert('Скопировано в буфер обмена: ' + text);
            }).catch(err => console.error('Ошибка копирования: ', err));
            return false;
        }
        function forceDownload(url, filename) {
            fetch(url).then(response => response.blob()).then(blob => {
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl; a.download = filename;
                document.body.appendChild(a); a.click();
                setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(blobUrl); }, 100);
            }).catch(error => console.error('Ошибка при скачивании файла:', error));
        }
        
        function logout() {
            currentClientData = null; currentPlaylistResult = null; currentTestPlaylistResult = null; 
            document.querySelector('.post-auth-layout').style.display = 'none';
            document.getElementById('preAuthContent').style.display = 'block';
            document.getElementById('howToConnectBlock').style.display = 'block';
            document.getElementById('whereItWorksBlock').style.display = 'block';
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.style.opacity = '0'; 
            setTimeout(() => {
                logoutBtn.style.display = 'none';
                ['regBtn', 'loginBtnNav'].forEach(id => {
                    const btn = document.getElementById(id);
                    btn.style.display = 'block';
                    btn.style.opacity = '1';
                });
            }, 300);
        }

        function showPlaylistPage() {
            ['preAuthContent', 'howToConnectBlock', 'whereItWorksBlock'].forEach(id => document.getElementById(id).style.display = 'none');
            document.querySelector('.post-auth-layout').style.display = 'flex';
            document.getElementById('playlistInfoPage').style.display = 'block';
            document.getElementById('paymentBlock').style.display = 'block';
            ['regBtn', 'loginBtnNav'].forEach(id => document.getElementById(id).style.display = 'none');
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.style.display = 'block';
            setTimeout(() => { logoutBtn.style.opacity = '1'; }, 100);
            
            document.getElementById('clientNameGreeting').textContent = `Привет, ${currentClientData.name || 'Клиент'}!`;
            document.getElementById('expirationMessage').textContent = `Ваш тариф ${getExpirationDays(currentClientData.paymentDate, currentClientData.months)}.`;
            
            // Здесь отображаем короткую ссылку
            document.getElementById('finalPlaylistLink').textContent = currentPlaylistResult.isgdUrl;
            
            // КНОПКА КОПИРОВАТЬ: Копирует короткую ссылку
            document.getElementById('copyLinkBtnPage').onclick = (e) => copyToClipboard(currentPlaylistResult.isgdUrl, e);
            
            // КНОПКА СКАЧАТЬ: Создаем прямую ссылку на СТАТИЧЕСКИЙ файл ОСНОВНОГО плейлиста для скачивания
            const downloadUrl = `${REPO_CONFIG.baseUrl}${currentClientData.phone}.m3u`;
            document.getElementById('downloadLinkBtnPage').onclick = () => {
                window.open(downloadUrl, '_blank'); 
            };
        }

        async function getFileSha(filename) {
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`;
            try {
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Accept': 'application/vnd.github+json' } });
                if (response.ok) return (await response.json()).sha;
                if (response.status === 404) return null;
                throw new Error(`Ошибка при получении SHA: ${response.statusText}`);
            } catch (error) { console.error('Ошибка при получении SHA:', error); return null; }
        }

        async function loadClientsFromGitHub() {
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`;
            const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Accept': 'application/vnd.github.v3+json' } });
            if (response.ok) {
                const data = await response.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                return { clients: JSON.parse(content) || [], sha: data.sha };
            }
            if (response.status === 404) return { clients: [], sha: null };
            throw new Error(`Ошибка загрузки: ${response.statusText}`);
        }

        async function updateClientData(client) {
            let { clients: currentClients, sha } = await loadClientsFromGitHub();
            const index = currentClients.findIndex(c => c.phone === client.phone);
            if (index === -1) throw new Error("Клиент не найден.");
            
            // Обновляем данные клиента
            currentClients[index] = client;
            
            const response = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `Обновлены данные клиента: ${client.name} (тест)`, content: btoa(unescape(encodeURIComponent(JSON.stringify(currentClients)))), branch: REPO_CONFIG.branch, sha: sha })
            });
            if (!response.ok) throw new Error((await response.json()).message || "Ошибка при сохранении данных клиента.");
            return true;
        }

        // =================================================================
        // ФУНКЦИЯ: Создание короткой ссылки
        // =================================================================
        async function createIsGdShortUrl(phone, isTest = false) {
            const cleanPhone = extractPhoneNumber(phone);
            const shortUrlAlias = isTest ? `test${cleanPhone}` : cleanPhone;
            
            const longUrl = isTest 
                            // Для тестового используем Netlify Function
                            ? `${REPO_CONFIG.baseUrl}api/playlist_link?phone=${cleanPhone}`
                            // Для платного используем статическую ссылку
                            : `${REPO_CONFIG.baseUrl}${cleanPhone}.m3u`;
            
            try {
                const apiUrl = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}&shorturl=${shortUrlAlias}`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                return data.errorcode ? `https://is.gd/${shortUrlAlias}` : data.shorturl;
            } catch (error) { 
                console.error('Ошибка создания is.gd ссылки:', error); 
                return `https://is.gd/${shortUrlAlias}`;
            }
        }
        // =================================================================

        // =================================================================
        // ФУНКЦИЯ: Создание тестового плейлиста (test{phone}.m3u)
        // =================================================================
        async function createTestPlaylist(phone) {
            const cleanPhone = extractPhoneNumber(phone);
            const filename = `public/test${cleanPhone}.m3u`;
            const key = '0000000000'; 
            
            // Использует редирект /sample.m3u
            const response = await fetch(REPO_CONFIG.samplePlaylist);
            if (!response.ok) throw new Error("Не удалось загрузить образец плейлиста sample.m3u.");
            
            let content = await response.text();
            content = content.replace(/\/iptv\/\w+\//g, `/iptv/${key}/`);
            
            const sha = await getFileSha(filename);
            const uploadResponse = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `Обновление ТЕСТОВОГО плейлиста: ${cleanPhone}`, content: btoa(unescape(encodeURIComponent(content))), branch: REPO_CONFIG.branch, sha: sha })
            });
            
            if (!uploadResponse.ok) throw new Error((await uploadResponse.json()).message || "Ошибка при загрузке тестового плейлиста");
            
            const isgdUrl = await createIsGdShortUrl(phone, true); 
            return { isgdUrl, m3uFilename: `test${cleanPhone}.m3u`, m3uContent: content };
        }
        // =================================================================

        async function createPlaylist(phone, key) {
            const cleanPhone = extractPhoneNumber(phone);
            if (cleanPhone.length < 10) throw new Error("Номер должен содержать минимум 10 цифр.");
            
            const filename = `public/${cleanPhone}.m3u`;
            // Использует редирект /sample.m3u
            const response = await fetch(REPO_CONFIG.samplePlaylist);
            if (!response.ok) throw new Error("Не удалось загрузить образец плейлиста sample.m3u.");
            
            let content = await response.text();
            content = content.replace(/\/iptv\/\w+\//g, `/iptv/${key}/`);
            
            const sha = await getFileSha(filename);
            const uploadResponse = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `Обновление плейлиста: ${cleanPhone}`, content: btoa(unescape(encodeURIComponent(content))), branch: REPO_CONFIG.branch, sha: sha })
            });
            
            if (!uploadResponse.ok) throw new Error((await uploadResponse.json()).message || "Ошибка при загрузке плейлиста");
            
            const isgdUrl = await createIsGdShortUrl(phone, false); 
            return { isgdUrl, m3uFilename: `${cleanPhone}.m3u`, m3uContent: content };
        }
        
        async function sendRegistrationToTelegram(clientData) {
            const regDate = new Date(clientData.registration_date).toLocaleDateString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            const message = `🔔 НОВАЯ РЕГИСТРАЦИЯ! 🔔\n\nИмя: ${clientData.name}\nТелефон: ${clientData.phone}\nДата: ${regDate}`;
            const apiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}&parse_mode=HTML`;
            
            try {
                await fetch(apiUrl, { method: 'POST' });
            } catch (error) {
                console.error('Ошибка при отправке в Telegram:', error);
            }
        }

        async function saveClientData(client) {
            let { clients: currentClients, sha } = await loadClientsFromGitHub();
            if (currentClients.some(c => c.phone === client.phone)) throw new Error("Клиент с таким номером уже зарегистрирован.");
            currentClients.push(client);
            const response = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `Добавлен новый клиент: ${client.name}`, content: btoa(unescape(encodeURIComponent(JSON.stringify(currentClients)))), branch: REPO_CONFIG.branch, sha: sha })
            });
            if (!response.ok) throw new Error((await response.json()).message || "Ошибка при сохранении данных клиента.");
            return true;
        }
        
        async function handleTestBtnClick() {
            if (!currentClientData) {
                alert('Сначала войдите в систему.');
                return;
            }
            
            if (isTestExpired(currentClientData)) {
                openModal('expiredTestModal');
                return;
            }
            
            try {
                if (!currentClientData.test_end_date) {
                    const today = new Date();
                    const endDate = new Date(today.getTime() + (3 * 24 * 60 * 60 * 1000)); // + 3 дня
                    currentClientData.test_end_date = endDate.toISOString().split('T')[0]; // Сохраняем дату в формате YYYY-MM-DD
                    
                    await updateClientData(currentClientData);
                }
                
                currentTestPlaylistResult = await createTestPlaylist(currentClientData.phone);
                
                const linkBox = document.getElementById('testPlaylistLinkBox');
                const copyBtn = document.getElementById('copyTestLinkBtn');
                
                linkBox.textContent = currentTestPlaylistResult.isgdUrl;
                copyBtn.onclick = (e) => copyToClipboard(currentTestPlaylistResult.isgdUrl, e);
                
                document.getElementById('testStatusMessage').style.display = 'none';
                
                openModal('testPlaylistModal');
                
            } catch (error) {
                showStatus(`❌ Ошибка создания тестового плейлиста: ${error.message}`, "error", 'testStatusMessage');
                console.error('Ошибка создания тестового плейлиста:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            window.handleTestBtnClick = handleTestBtnClick; // Добавляем функцию в глобальный scope
            
            document.getElementById('registrationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('clientName').value.trim();
                const phone = document.getElementById('clientPhone').value.trim();
                const password = document.getElementById('clientPassword').value;
                const passwordRepeat = document.getElementById('clientPasswordRepeat').value;
                const cleanPhoneDigits = extractPhoneNumber(phone);
                
                if (!name || !phone || !password || password !== passwordRepeat || password.length < 6 || cleanPhoneDigits.length < 10) {
                    showStatus("Проверьте поля: заполнены, пароли совпадают (мин. 6 симв.), телефон (мин. 10 цифр).", "error");
                    return;
                }
                const newClient = { name, phone: cleanPhoneDigits, password, key: '0000000000', paymentDate: new Date().toISOString().split('T')[0], months: '1', registration_date: new Date().toISOString() };
                try {
                    await sendRegistrationToTelegram(newClient);
                    
                    currentPlaylistResult = await createPlaylist(phone, newClient.key);
                    await saveClientData(newClient);
                    currentClientData = newClient;
                    
                    document.getElementById('registrationForm').reset();
                    closeModal('registrationModal');
                    document.getElementById('loginPhone').value = phone; 
                    document.getElementById('loginPassword').value = password; 
                    openModal('loginModal');
                } catch (error) { showStatus(`❌ Ошибка: ${error.message}`, "error"); console.error('Ошибка регистрации:', error); }
            });

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const loginPhone = document.getElementById('loginPhone').value.trim();
                const loginPassword = document.getElementById('loginPassword').value;
                const cleanLoginPhoneDigits = extractPhoneNumber(loginPhone);
                if (!loginPhone || !loginPassword) { showStatus('Заполните все поля.', "error", 'loginStatusMessage'); return; }
                try {
                    const { clients } = await loadClientsFromGitHub();
                    const client = clients.find(c => c.phone === cleanLoginPhoneDigits && c.password === loginPassword);
                    if (client) {
                        currentClientData = client;
                        currentPlaylistResult = await createPlaylist(loginPhone, client.key || '0000000000');
                        closeModal('loginModal');
                        showPlaylistPage();
                    } else { showStatus('Неверный номер или пароль.', "error", 'loginStatusMessage'); }
                } catch (error) { showStatus(`❌ Ошибка входа: ${error.message}`, "error", 'loginStatusMessage'); console.error('Ошибка входа:', error); }
            });
            
            // --- НОВЫЙ КОД: Переключение на страницу списка каналов ---
            document.getElementById('showChannelListBtn').addEventListener('click', function() {
                document.getElementById('mainPageContent').style.display = 'none';
                document.getElementById('channelListPage').style.display = 'block';
                document.getElementById('authButtonsContainer').style.display = 'none';
                document.querySelector('.admin-button-container').style.display = 'none';
            });
            document.getElementById('backToMainBtn').addEventListener('click', function() {
                document.getElementById('channelListPage').style.display = 'none';
                document.getElementById('mainPageContent').style.display = 'block';
                document.getElementById('authButtonsContainer').style.display = 'flex';
                document.querySelector('.admin-button-container').style.display = 'block';
            });
        });

        window.openModal = openModal;
        window.closeModal = closeModal;
        window.logout = logout;
    </script>
    
    <script>
        // =================================================================
        // СКРИПТ ДЛЯ СТРАНИЦЫ СПИСКА КАНАЛОВ (из index01.html)
        // =================================================================
        (function() {
            // Использует редирект /moe.m3u (см. netlify.toml)
            const url = `${BASE_URL}moe.m3u`;
            const categoriesEl = document.getElementById('categories');
            const searchResultsEl = document.getElementById('search-results');
            const channelModal = document.getElementById('channelModal');
            const modalTitle = document.getElementById('modal-title');
            const channelList = document.getElementById('channel-list');
            const mainSearch = document.getElementById('main-search');
            const modalSearch = document.getElementById('modal-search');

            let dataByGroup = {};
            let allChannels = [];
            let allCategories = [];

            window.closeChannelModal = function() {
                channelModal.style.display = 'none';
            }

            async function fetchAndParseM3U() {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const text = await res.text();
                    const lines = text.split('\n');
                    let currentInfo = '';
                    let currentGroup = 'Без категории';

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('#EXTINF')) { currentInfo = line; } 
                        else if (line.startsWith('#EXTGRP')) { currentGroup = line.replace('#EXTGRP:', '').trim(); } 
                        else if (line && !line.startsWith('#')) {
                            const titleMatch = currentInfo.match(/,(.*)$/);
                            const title = titleMatch ? titleMatch[1] : 'Неизвестный канал';
                            if (!dataByGroup[currentGroup]) dataByGroup[currentGroup] = [];
                            const channelData = { title, group: currentGroup, url: line };
                            dataByGroup[currentGroup].push(channelData);
                            allChannels.push(channelData);
                            currentGroup = 'Без категории'; // Reset group for next entry
                        }
                    }
                    allCategories = Object.keys(dataByGroup).sort();
                    renderCategories();
                } catch (error) {
                    console.error("Failed to fetch and parse M3U file:", error);
                    categoriesEl.innerHTML = "<p>Не удалось загрузить список каналов. Попробуйте позже.</p>";
                }
            }

            function renderCategories() {
                categoriesEl.innerHTML = '';
                searchResultsEl.innerHTML = '';
                categoriesEl.style.display = 'grid';
                allCategories.forEach(group => {
                    const count = dataByGroup[group].length;
                    const el = document.createElement('div');
                    el.className = 'category';
                    el.innerHTML = `<div class="category-name">${group}</div><div class="category-count">Каналов: ${count}</div>`;
                    el.onclick = () => openChannelModal(group);
                    categoriesEl.appendChild(el);
                });
            }

            function openChannelModal(group) {
                modalTitle.textContent = group;
                channelList.innerHTML = '';
                dataByGroup[group].forEach(channel => {
                    const ch = document.createElement('div');
                    ch.className = 'channel';
                    ch.textContent = channel.title;
                    channelList.appendChild(ch);
                });
                channelModal.style.display = 'flex';
                modalSearch.value = '';
                modalSearch.focus();
                modalSearch.oninput = function() {
                    const searchTerm = this.value.toLowerCase();
                    channelList.querySelectorAll('.channel').forEach(channel => {
                        channel.style.display = channel.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
                    });
                };
            }

            mainSearch.oninput = function() {
                const searchTerm = this.value.toLowerCase().trim();
                if (searchTerm === '') { renderCategories(); return; }
                categoriesEl.style.display = 'none';
                searchResultsEl.innerHTML = '';
                const foundChannels = allChannels.filter(channel => channel.title.toLowerCase().includes(searchTerm));
                if (foundChannels.length === 0) {
                    searchResultsEl.innerHTML = '<div style="padding: 2rem; text-align: center; font-size: 1.2rem; color: var(--text-light);">Каналы не найдены</div>';
                    return;
                }
                foundChannels.forEach(channel => {
                    const el = document.createElement('div');
                    el.className = 'channel-result';
                    el.innerHTML = `<div>${channel.title}</div><div class="channel-category">${channel.group}</div>`;
                    el.onclick = () => {
                        openChannelModal(channel.group);
                        setTimeout(() => {
                            channelList.querySelectorAll('.channel').forEach(ch => {
                                if (ch.textContent === channel.title) {
                                    ch.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    ch.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
                                    setTimeout(() => ch.style.backgroundColor = '', 2000);
                                }
                            });
                        }, 100);
                    };
                    searchResultsEl.appendChild(el);
                });
            };

            window.onclick = function(e) {
                if (e.target === channelModal) closeChannelModal();
            };
            window.onkeydown = function(e) {
                if (e.key === "Escape" && channelModal.style.display === 'flex') closeChannelModal();
            }
            fetchAndParseM3U();
        })();
    </script>
</body>
</html>