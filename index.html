<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Доступное IPTV | Вход и Регистрация</title>
    
    <meta property="og:title" content="Доступное IPTV | Вход и Регистрация" />
    <meta property="og:description" content="4000 каналов IPTV в отличном качестве с архивом. Вход и регистрация." />
    <meta property="og:url" content="https://iptv-me.netlify.app/" />
    <meta property="og:image" content="https://iptv-me.netlify.app/client/iptv.png" />
    <meta property="og:type" content="website" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <link rel="icon" href="https://iptv-me.netlify.app/icon.ico">
    
    <style>
        :root {
            --system-blue: #007AFF;
            --system-gray-light: #F2F2F7;
            --system-green: #34C759;
            --system-red: #FF3B30;
            --system-purple: #5856D6;
            --blue-hover: #0056b3;
            --green-hover: #218838;
            --purple-hover: #4341A5;
            --qr-color: #333;
            --text-dark: #333;
            --text-light: #666;
            /* Новый цвет для кнопки "Взять тест" */
            --system-orange: #FF9500;
            --orange-hover: #CC7700;
        }

        /* Общие стили и фон */
        html {
            box-sizing: border-box;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #FFFFFF;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #333;
            flex-direction: column;
            position: relative;
            overflow-x: hidden; 
        }

        .page-wrapper {
            width: 100%;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* АНИМАЦИЯ ПОЯВЛЕНИЙ ЭЛЕМЕНТОВ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { transform: scale(1); opacity: 1; }
        }

        /* КОНТЕЙНЕР ОСНОВНОГО КОНТЕНТА (НАСТОЛЬНЫЙ) */
        .main-content {
            max-width: 700px;
            text-align: center; 
            padding: 20px;
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            animation-delay: 0.2s;
            /* ИЗМЕНЕНИЕ ДЛЯ ЦЕНТРИРОВАНИЯ БЛОКА */
            margin-left: auto;
            margin-right: auto;
        }

        .main-content h1 {
            font-size: 38px;
            color: var(--system-blue);
            margin-bottom: 20px;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .main-content p {
            font-size: 18px;
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px; 
        }
        
        /* =================================================== */
        /* СТИЛИ БЛОКА "КАК ПОДКЛЮЧИТЬ IPTV" */
        /* =================================================== */
        .how-to-connect-block {
            max-width: 1000px;
            width: 100%;
            padding: 30px 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            animation-delay: 0.5s;
            margin-top: 40px;
            margin-bottom: 40px; 
        }

        .how-to-connect-block h2 {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }

        .steps-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            flex-wrap: wrap;
        }

        .step-item {
            /* Убеждаемся, что при широком экране два элемента поместятся в ряд */
            flex-basis: 40%; 
            min-width: 200px;
            text-align: center;
            padding: 10px;
            transition: transform 0.3s ease;
        }
        
        @media (max-width: 500px) {
            .step-item {
                /* На мобильных устройствах элементы будут в одном столбце */
                flex-basis: 90%;
            }
        }
        
        .step-item:hover {
            transform: translateY(-5px);
        }

        .step-number {
            width: 40px;
            height: 40px;
            line-height: 40px;
            background: var(--system-blue); 
            color: white;
            border-radius: 50%;
            font-size: 20px;
            font-weight: 900;
            margin: 0 auto 15px;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            transition: transform 0.3s ease;
        }
        
        .step-item:hover .step-number {
            transform: scale(1.1);
        }

        .step-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--system-blue);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .step-description {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }

        .step-description a {
             color: var(--system-blue);
             text-decoration: none;
             font-weight: 600;
             transition: color 0.2s ease;
        }
        
        .step-description a:hover {
             color: var(--blue-hover);
             text-decoration: underline;
        }

        /* =================================================== */
        /* СТИЛИ БЛОКА "ГДЕ РАБОТАЕТ IPTV?" */
        /* =================================================== */
        .where-it-works-block {
            max-width: 1000px;
            width: 100%;
            padding: 30px 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards;
            animation-delay: 0.8s;
            margin-bottom: 40px;
        }

        .where-it-works-block h2 {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }

        .devices-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px 20px;
            justify-items: center;
            padding: 0 5%;
        }

        .device-item {
            text-align: center;
            padding: 10px;
            transition: transform 0.3s ease;
        }
        
        .device-item:hover {
            transform: translateY(-5px);
        }

        /* ИЗМЕНЕНИЕ: Убираем круги, фон и тени вокруг иконок */
        .device-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80px;
            height: 80px;
            border-radius: 0; /* Удаляем скругление */
            background: none; /* Удаляем фон */
            margin: 0 auto 10px; /* Сохраняем нижний отступ */
            box-shadow: none; /* Удаляем тень */
        }
        
        .device-icon img {
            width: 70%;
            height: 70%;
            object-fit: contain;
        }

        .device-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        /* =================================================== */
        /* СТИЛИ БЛОКА ПЛЕЙЛИСТА (ПОСЛЕ АВТОРИЗАЦИИ) */
        /* =================================================== */
        .post-auth-layout {
            display: none;
            justify-content: center;
            max-width: 1200px;
            width: 100%;
            gap: 30px;
            margin-top: 50px;
            margin-bottom: 50px;
            animation: fadeInScale 0.6s ease-out forwards;
        }

        .playlist-info-page,
        .payment-block {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            flex: 1; 
            min-width: 300px;
            text-align: center;
        }
        
        .playlist-info-page { display: block; }
        .payment-block { display: block; }
        
        .client-greeting {
            color: var(--system-blue);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .playlist-info-page h2 {
            color: #333;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .expiration-info {
            font-size: 18px;
            font-weight: 600;
            color: var(--system-red);
            margin-bottom: 25px;
        }

        .playlist-link-box {
            background: var(--system-gray-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            word-break: break-all;
            font-size: 16px;
            font-weight: 500;
            text-align: left; /* Для лучшей читаемости длинной ссылки */
        }
        
        .playlist-info-actions {
            display: flex;
            gap: 12px;
            flex-direction: column;
            width: 100%;
            max-width: 300px; 
            margin: 0 auto;
        }

        .playlist-info-actions button {
            width: 100%;
            font-size: 20px; 
            padding: 15px;
            border-radius: 8px;
            color: white; 
            font-weight: 700;
            border: none;
            outline: none;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .playlist-info-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        
        .playlist-info-actions button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        #copyLinkBtnPage:hover { background: var(--blue-hover) !important; }
        #downloadLinkBtnPage:hover { background: var(--green-hover) !important; }

         /* Стили для новой кнопки "Взять тест" */
        #getTestBtn {
            background: var(--system-orange);
            box-shadow: 0 4px 10px rgba(255, 149, 0, 0.4);
            font-size: 20px; 
            padding: 15px;
            border-radius: 8px;
            color: white; 
            font-weight: 700;
            border: none;
            outline: none;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; 
            box-shadow: 0 4px 10px rgba(255, 149, 0, 0.4);
            width: 100%;
            max-width: 300px;
            display: block;
            margin: 0 auto 15px; /* Уменьшаем нижний отступ, чтобы добавить таймер */
        }
        #getTestBtn:hover {
            background: var(--orange-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 149, 0, 0.5);
        }
        #getTestBtn:active {
             transform: translateY(0);
            box-shadow: 0 2px 5px rgba(255, 149, 0, 0.4);
        }
        
        /* СТИЛИ ДЛЯ ТАЙМЕРА ОБРАТНОГО ОТСЧЕТА */
        #testCountdownTimer {
            display: none; /* По умолчанию скрыт */
            margin: 0 auto 25px;
            padding: 10px 15px;
            max-width: 300px;
            border: 2px solid var(--system-orange);
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--system-orange);
            background: #fff8f0;
            box-shadow: 0 2px 10px rgba(255, 149, 0, 0.2);
        }
        
        #testCountdownTimer.active {
            display: block; /* Отображается, когда активен */
        }


        /* СТИЛИ БЛОКА ОПЛАТЫ */
        .payment-block h2 {
            color: var(--system-green);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .card-number-display {
            background: var(--system-gray-light);
            padding: 15px;
            border-radius: 8px;
            margin: 0 auto 20px;
            font-size: 22px;
            font-weight: 700;
            color: #333;
            max-width: 300px;
            overflow-wrap: break-word; 
        }

        .payment-amount {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .submit-btn-modern {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: var(--system-blue); 
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            z-index: 1;
            display: block;
        }

        .payment-btn {
            background: var(--system-green) !important;
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.4) !important;
            margin-top: 10px; 
        }
        
        .payment-btn:hover {
            background: var(--green-hover) !important;
            box-shadow: 0 8px 25px rgba(52, 199, 89, 0.6) !important;
        }
        
        .copy-card-btn {
            background: var(--system-blue);
            color: white;
            font-weight: 700;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
            font-size: 16px;
            width: 100%; 
            max-width: 300px;
            margin: 0 auto; 
            display: block; 
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4); 
        }
        
        .copy-card-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }
        
        .copy-card-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }

        /* Стили для модального окна тестового плейлиста */
        #testPlaylistModal .modal-content {
            max-width: 450px;
        }
        #testPlaylistModal h2 {
            color: var(--system-orange);
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }
        #testPlaylistLinkBox {
            background: var(--system-gray-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            word-break: break-all;
            font-size: 16px;
            font-weight: 500;
            text-align: left; /* Для лучшей читаемости длинной ссылки */
        }
        
        /* ОБЩИЙ СТИЛЬ ДЛЯ КНОПОК ТЕСТОВОЙ МОДАЛКИ (Перейти и Копировать) */
        #goToTestLinkBtn {
            font-size: 20px; 
            padding: 15px; 
            font-weight: 700;
            border-radius: 8px;
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            width: 100%;
            max-width: 90%;
            margin: 5px auto; 
            display: block;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4); 
        }

        #goToTestLinkBtn {
             background: var(--system-orange);
             box-shadow: 0 4px 10px rgba(255, 149, 0, 0.4);
             margin-top: 15px;
        }

        #goToTestLinkBtn:hover {
            background: var(--orange-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 149, 0, 0.5);
        }
        /* Стили для модального окна истечения теста */
        #expiredTestModal .modal-content {
            max-width: 400px;
            text-align: center;
            border: 2px solid var(--system-red);
        }
        #expiredTestModal h2 {
            color: var(--system-red);
            font-size: 24px;
        }
        #expiredTestModal p {
            font-size: 18px;
            color: #333;
            margin-bottom: 30px;
        }
        
        /* Стили для модальных окон */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        @keyframes modalOpen {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-content {
            background: white;
            width: 80%;
            max-width: 400px;
            border-radius: 14px;
            padding: 25px;
            animation: modalOpen 0.3s ease-out;
            position: relative;
        }

        /* Стили для закрытия модалки */
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 35px;
            height: 35px;
            line-height: 35px;
            text-align: center;
            font-size: 28px;
            color: white;
            background: var(--system-blue);
            border-radius: 50%;
            cursor: pointer;
            opacity: 0.9;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, opacity 0.2s ease, background 0.2s ease;
            font-weight: 300;
            z-index: 10;
        }
        .close-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background: var(--system-red);
        }
        
        /* Input styling for modals */
        .input-group-modern { position: relative; margin-bottom: 35px; }
        .input-group-modern input {
            width: 100%;
            padding: 15px 10px 5px 10px;
            background: none;
            border: none;
            border-bottom: 2px solid #ccc;
            font-size: 16px;
            color: #333;
            outline: none;
            transition: border-bottom-color 0.3s ease;
        }
        .input-group-modern input:focus,
        .input-group-modern input:not(:placeholder-shown) {
            border-bottom-color: var(--system-blue);
        }
        .input-group-modern label {
            position: absolute;
            top: 15px;
            left: 10px;
            color: #999;
            font-size: 16px;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        .input-group-modern input:focus + label,
        .input-group-modern input:not(:placeholder-shown) + label {
            top: -10px;
            left: 0;
            font-size: 12px;
            color: var(--system-blue);
        }
        
        #loginModal .input-group-modern,
        #registrationModal .input-group-modern {
            max-width: 80%; 
            margin: 0 auto 35px; 
        }

        .submit-btn-modern:not(#loginBtn) {
            width: 100%;
            max-width: 300px; 
            margin: 0 auto; 
            display: block;
        }

        #loginBtn,
        #registrationModal .submit-btn-modern {
            width: 100%;
            max-width: 80%;
            margin: 0 auto;
            display: block;
        }
        
        /* =================================================== */
        /* СТИЛИ ДЛЯ СТРАНИЦЫ СПИСКА КАНАЛОВ (CSS) */
        /* =================================================== */
        #channelListPage { 
            width: 100%; 
            position: relative;
            padding-top: 71px; 
        }
        
        /* Стили для Заголовка */
        .channel-list-title {
            position: fixed;
            top: 0; 
            left: 0;
            right: 0;
            height: 71px;
            line-height: 71px;
            padding: 0 1.5rem;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-bottom: 1px solid #e5e5e5;
            z-index: 101; 
            
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: var(--system-blue);
            margin: 0; 
            display: block;
        }
        
        /* Стили для Кнопки "Назад" (Удалено) */
        #backToMainBtn {
            display: none; 
        }

        #channelListPage .search-container {
            padding: 1.5rem 1rem;
            background: white;
            position: sticky;
            top: 71px; /* Смещение ниже фиксированного заголовка */
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        #channelListPage .search-input {
            width: 80%;
            max-width: 1200px; 
            margin: 0 auto;
            display: block;
            padding: 0.9rem 1.2rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1rem;
            font-family: 'Montserrat', sans-serif;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, width 0.3s ease;
        }
        #channelListPage .search-input:focus {
            border-color: var(--system-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        #channelListPage .categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        #channelListPage .category {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid #e0e0e0;
            animation: fadeIn 0.5s ease-out forwards;
        }
        #channelListPage .category:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }
        #channelListPage .category-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--system-blue);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        #channelListPage .category-count {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }
        #channelListPage #search-results {
            padding: 1rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        #channelListPage .channel-result {
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.2s ease;
            animation: fadeIn 0.4s ease-out forwards;
        }
        #channelListPage .channel-result:hover {
            background-color: #f9f9f9;
            transform: scale(1.02);
        }
        #channelListPage .channel-category {
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            background: var(--system-blue);
            padding: 0.3rem 0.6rem;
            border-radius: 16px;
            text-transform: uppercase;
        }
        
        #channelListPage .modal {
            /* Переопределяем модалку для страницы списка каналов */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: flex-start;
            padding: 0;
            overflow-y: auto;
        }
        #channelListPage .modal-content {
            background: white;
            width: 90%; 
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 14px;
            padding: 25px;
            position: relative;
            animation: modalOpen 0.3s ease-out;
            margin-top: 150px; 
            margin-bottom: 20px;
        }
        
        #channelListPage #channelModal .close-btn {
            top: 15px;
            right: 15px;
        }
        
        #channelListPage .modal h2 {
            margin-top: 0;
            margin-bottom: 2rem;
            color: var(--system-blue);
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
            font-size: 1.8rem;
        }
        #channelListPage .modal-search {
            width: 80%;
            max-width: 100%;
            display: block;
            margin: 0 auto 1.5rem;
            padding: 0.9rem 1.2rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #channelListPage .modal-search:focus {
            border-color: var(--system-blue);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        #channelListPage #channel-list {
          max-height: 60vh;
          overflow-y: auto;
          padding-right: 10px; 
        }
        #channelListPage .channel {
            margin-bottom: 0.5rem;
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 500;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        #channelListPage .channel:hover { background-color: var(--system-gray-light); }
        #channelListPage .channel:last-child { border-bottom: none; }
        
        @media (max-width: 600px) {
            .channel-list-title {
                font-size: 1.2rem;
                height: 55px;
                line-height: 55px;
            }
            #channelListPage {
                padding-top: 55px; /* Корректировка отступа для мобильных */
            }
            #channelListPage .categories { padding: 1rem; gap: 1rem; }
            #channelListPage #search-results { padding: 1rem; }
            #channelListPage .channel-result { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            
            #channelListPage .search-container {
                padding: 1rem;
                top: 55px; /* Прилипает ниже заголовка */
            }
            
            #channelListPage .modal-content {
                margin-top: 100px; /* Сохраняем отступ для модалки, чтобы она была ниже поиска */
            }
        }
        
        /* =================================================== */
        /* СТИЛИ ДЛЯ КНОПОК НАВИГАЦИИ (ВОССТАНОВЛЕННЫЙ CSS) */
        /* =================================================== */
        
        /* Стили для кнопки "Список каналов" */
        .channel-list-btn {
            display: inline-block;
            margin-top: 20px;
            margin-bottom: 30px;
            padding: 18px 36px;
            background: var(--system-blue);
            color: white;
            font-size: 22px;
            font-weight: 700;
            border-radius: 10px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            /* ЦЕНТРИРОВАНИЕ КНОПКИ */
            margin-left: auto;
            margin-right: auto;
            display: block; 
        }
        .channel-list-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }

        .auth-buttons-container {
            position: fixed; 
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 110;
        }
        
        .admin-button-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 110;
        }

        .auth-btn {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            background: var(--system-blue);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            display: block; 
            opacity: 1;
            text-decoration: none;
        }
        .auth-btn:hover {
            background: var(--blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.5);
        }
        .auth-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }

        .admin-btn {
            background-color: var(--system-purple);
            box-shadow: 0 4px 10px rgba(88, 86, 214, 0.4);
        }
        .admin-btn:hover {
            background-color: var(--purple-hover);
            box-shadow: 0 6px 15px rgba(88, 86, 214, 0.5);
        }
        
        #logoutBtn {
             background-color: var(--system-red) !important;
             box-shadow: 0 4px 10px rgba(255, 59, 48, 0.4) !important;
             transition: opacity 0.3s ease, background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
             display: none; 
             opacity: 0;
        }
        #logoutBtn:hover {
             background-color: #cc0000 !important;
             box-shadow: 0 6px 15px rgba(255, 59, 48, 0.5) !important;
        }
        /* =================================================== */
        /* НОВЫЕ СТИЛИ: Уведомление (Тост) и Прелоадер */
        /* =================================================== */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 90%;
            pointer-events: none; /* Чтобы не блокировать клики на странице */
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateX(100%);
            font-size: 16px;
            font-weight: 500;
            pointer-events: all; 
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1001; /* Выше модалок */
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 123, 255, 0.1);
            border-top-color: var(--system-blue);
            border-radius: 50%;
            animation: spinner 0.8s ease-in-out infinite;
        }
        /* =================================================== */
        /* ОБЩАЯ АДАПТИВНОСТЬ (повтор из client/index.html) */
        /* =================================================== */
        @media (max-width: 900px) {
            .post-auth-layout { flex-direction: column; gap: 40px; }
        }
        @media (max-width: 768px) {
            .devices-container { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 500px) {
            .devices-container { grid-template-columns: 1fr; }
            .main-content { margin-top: 80px; }
            .main-content h1 { font-size: 32px; line-height: 1.2; }
            .main-content p { font-size: 18px; }
            .how-to-connect-block h2, .where-it-works-block h2 { font-size: 24px; }
            .step-title, .device-name { font-size: 16px; }
            .step-description { font-size: 15px; }
            .steps-container { gap: 30px; }
            .step-item { flex-basis: 90%; }
            .auth-buttons-container { top: 10px; right: 10px; }
            .admin-button-container { top: 10px; left: 10px; }
            .client-greeting { font-size: 24px; }
            .playlist-info-page h2 { font-size: 18px; }
            .card-number-display { font-size: 20px; }
            .playlist-info-actions, .copy-card-btn, .submit-btn-modern { max-width: 90%; }
            #loginModal .input-group-modern, #registrationModal .input-group-modern { max-width: none; }
        }
    </style>
</head>
<body>
    
    
    <div class="auth-buttons-container" id="authButtonsContainer">
        <button class="auth-btn" id="regBtn" onclick="openModal('registrationModal')">Регистрация</button>
        <button class="auth-btn" id="loginBtnNav" onclick="openModal('loginModal')">Вход</button>
        <button class="auth-btn" id="logoutBtn" onclick="logout()">Выход</button>
    </div>

    <div class="page-wrapper">
        <div id="mainPageContent">
            <div class="main-content" id="preAuthContent">
                <h1>Доступное IPTV — 4000 каналов IPTV в отличном качестве с архивом.</h1>
                <p>Современный сервис IPTV телевидения, который дает возможность смотреть каналы в Full HD и Ultra HD качестве. Плейлист IPTV телевидения насчитывает 4000 IPTV каналов. Присоединяйтесь к нам и желаем Вам приятного просмотра</p>
                <button class="channel-list-btn" onclick="window.location.href='https://iptv-spisok.netlify.app/'">Список каналов</button>
            </div>

            <div class="how-to-connect-block" id="howToConnectBlock">
                <h2>Как подключить IPTV</h2>
                <div class="steps-container">
                    <div class="step-item">
                        <div class="step-number">1</div><div class="step-title">Регистрация</div>
                        <div class="step-description">Нажмите кнопку Регистрация</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">2</div><div class="step-title">Плейлист</div>
                        <div class="step-description">Скачать плейлист</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">3</div><div class="step-title">Загрузка</div>
                        <div class="step-description">Загрузить плейлист в Ваше устройство</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">4</div><div class="step-title">Оплата</div>
                        <div class="step-description">Оплатить подписку</div>
                    </div>
                </div>
            </div>
            
            <div class="where-it-works-block" id="whereItWorksBlock">
                <h2>Где работает IPTV?</h2>
                <div class="devices-container">
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-me.netlify.app/assets/smartphone-call.png" alt="Смартфон"></div>
                        <div class="device-name">На смартфоне</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-me.netlify.app/assets/computer-tablet.png" alt="Планшет"></div>
                        <div class="device-name">На планшете</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-me.netlify.app/assets/tv-box.png" alt="ТВ приставка"></div>
                        <div class="device-name">На ТВ приставке</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-me.netlify.app/assets/tv.png" alt="Smart TV"></div>
                        <div class="device-name">На Smart TV телевизоре</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-me.netlify.app/assets/tv-tuner.png" alt="Спутниковый тюнер"></div>
                        <div class="device-name">На спутниковом тюнере</div>
                    </div>
                    <div class="device-item">
                        <div class="device-icon"><img src="https://iptv-me.netlify.app/assets/laptop.png" alt="Компьютер"></div>
                        <div class="device-name">На компьютере и ноутбуке</div>
                    </div>
                </div>
            </div>

            <div class="post-auth-layout">
                <div id="playlistInfoPage" class="playlist-info-page">
                    <p class="client-greeting" id="clientNameGreeting"></p>
                    <h2 style="font-weight: 600;">Ваш плейлист</h2> 
                    <p class="expiration-info" id="expirationMessage"></p>
                    <button id="getTestBtn" onclick="handleTestBtnClick()">Взять тест</button>
                    <div id="testCountdownTimer"></div> 
                    <p style="color: #666; margin-bottom: 25px;">Используйте ссылку ниже для подключения к IPTV-сервису на вашем устройстве.</p>
                    <div class="playlist-link-box" id="finalPlaylistLink">Загрузка...</div>
                    <div class="playlist-info-actions">
                        <button id="copyLinkBtnPage" style="background: var(--system-blue);">Копировать ссылку</button>
                        <button id="downloadLinkBtnPage" style="background: var(--system-green);">Скачать файл</button>
                    </div>
                </div>
                <div id="paymentBlock" class="payment-block playlist-info-page">
                    <h2>Оплата подписки</h2>
                    <p class="payment-amount">Оплатить 150 грн</p>
                    <div class="card-number-display" id="cardNumberDisplay">5168752084846610</div>
                    <button class="copy-card-btn" onclick="copyToClipboard('5168752084846610', event)">Копировать номер</button>
                    <p style="color: #666; margin-top: 20px; margin-bottom: 25px; font-size: 14px;">Скопируйте номер карты, чтобы оплатить подписку.</p>
                    <button class="submit-btn-modern payment-btn" onclick="window.open('https://www.privat24.ua/send/32xla', '_blank')">Перейти к оплате</button>
                </div>
            </div>
        </div>
        
        <div id="channelListPage" style="display: none;">
            
            <h1 class="channel-list-title">Плейлист 4030 каналов</h1>
            
            <div class="search-container">
                <input type="text" class="search-input" id="main-search" placeholder="Поиск по всем каналам...">
            </div>
            <div class="categories" id="categories"></div>
            <div id="search-results"></div>

            <div class="modal" id="channelModal">
                <div class="modal-content">
                    <span class="close-btn" onclick="closeChannelModal()">×</span>
                    <h2 id="modal-title"></h2>
                    <input type="text" class="modal-search" id="modal-search" placeholder="Поиск в этой категории...">
                    <div id="channel-list"></div>
                </div>
            </div>
        </div>
    </div>


    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('registrationModal')">&times;</span>
            <h1 style="text-align: center; margin-bottom: 20px;">Регистрация</h1>
            <form id="registrationForm" onsubmit="return false;">
                <div class="input-group-modern"><input type="text" id="clientName" required placeholder=" "><label for="clientName">Ваше имя</label></div>
                <div class="input-group-modern"><input type="tel" id="clientPhone" required placeholder=" "><label for="clientPhone">Номер телефона</label></div>
                <div class="input-group-modern"><input type="password" id="clientPassword" required placeholder=" "><label for="clientPassword">Пароль</label></div>
                <div class="input-group-modern"><input type="password" id="clientPasswordRepeat" required placeholder=" "><label for="clientPasswordRepeat">Повторите пароль</label></div>
                <button type="submit" class="submit-btn-modern">Зарегистрироваться</button>
                <div id="statusMessage" class="status-message"></div>
            </form>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">Вход</h2>
            <form id="loginForm" onsubmit="return false;">
                <div class="input-group-modern"><input type="tel" id="loginPhone" required placeholder=" "><label for="loginPhone">Номер телефона</label></div>
                <div class="input-group-modern"><input type="password" id="loginPassword" required placeholder=" "><label for="loginPassword">Пароль</label></div>
                <button type="submit" id="loginBtn" class="submit-btn-modern">Войти</button>
            </form>
            <div id="loginStatusMessage" class="status-message"></div>
        </div>
    </div>
    
    <div id="testPlaylistModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('testPlaylistModal')">&times;</span>
            <h2>Ваш тестовый плейлист</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 16px;">Скопируйте ссылку ниже и используйте ее для подключения к IPTV-сервису.</p>
            <div class="playlist-link-box" id="testPlaylistLinkBox" style="cursor: pointer;"></div>
            <button class="submit-btn-modern" id="goToTestLinkBtn" style="background: var(--system-orange); margin-top: 15px;">Перейти по ссылке</button>
            <div id="testStatusMessage" class="status-message"></div>
        </div>
    </div>
    <div id="expiredTestModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('expiredTestModal')">&times;</span>
            <h2>Тестовый период завершен</h2>
            <p>Ваш тестовый период истек, оплатите подписку.</p>
            <button class="submit-btn-modern payment-btn" onclick="closeModal('expiredTestModal'); document.getElementById('paymentBlock').scrollIntoView({ behavior: 'smooth' });">Перейти к оплате</button>
        </div>
    </div>

    <div id="toast-container"></div>
    
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <script>
        // =================================================================
        // КОНФИГУРАЦИЯ (Извлечена из переменных окружения Netlify)
        // =================================================================
        // ВАЖНО: Эти константы должны быть настроены как ENV-переменные в Netlify
        const GITHUB_TOKEN_PART_1 = 'github_pat_11BZHLDUY0CUjtMkr0WawK_'; 
        const GITHUB_TOKEN_PART_2 = 'iarVu6LBY5xiS9T9ACIZCOC5J'; 
        const GITHUB_TOKEN_PART_3 = 'f8nYegQuXyN82KfEvILKU6Z3CB3jqxGIrN';

        const BASE_URL = 'https://iptv-me.netlify.app/'; 
        const REPO_CONFIG = {
            owner: "zpvapp", repo: "iptv", branch: "main",
            clientsFile: "public/clients.json",
            // Использует редирект /sample.m3u (см. netlify.toml)
            samplePlaylist: `${BASE_URL}sample.m3u`, 
            baseUrl: BASE_URL
        };
        
        // --- КОНСТАНТЫ TELEGRAM ---
        const TELEGRAM_BOT_TOKEN = '8457795718:AAH60EaVEHhS2AM1YJy1CQUHt8NMN4d2z34';
        const TELEGRAM_CHAT_ID = '351875366';
        
        let currentClientData = null; 
        let currentPlaylistResult = null;
        let currentTestPlaylistResult = null; 
        let countdownTimerInterval = null; // Переменная для хранения интервала таймера
        
        function getGitHubToken() { return GITHUB_TOKEN_PART_1 + GITHUB_TOKEN_PART_2 + GITHUB_TOKEN_PART_3; }

        function getExpirationDays(paymentDate, months) {
            if (!paymentDate || !months) return "данные отсутствуют";
            const start = new Date(paymentDate);
            const durationMonths = parseInt(months, 10);
            if (isNaN(durationMonths) || durationMonths <= 0) return "данные отсутствуют";
            const expirationDate = new Date(start);
            expirationDate.setMonth(expirationDate.getMonth() + durationMonths);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            expirationDate.setHours(0, 0, 0, 0);
            const diffTime = expirationDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays > 0) return `заканчивается через ${diffDays} дн.`;
            if (diffDays === 0) return "заканчивается сегодня!";
            return `закончился ${Math.abs(diffDays)} дн. назад`;
        }
        
        // НОВАЯ ФУНКЦИЯ: Проверка истечения тестового периода
        function isTestExpired(clientData) {
            if (!clientData || !clientData.test_end_date || clientData.test_end_date === "N/A") {
                return false; 
            }
            
            // Если дата имеет время, используем точное сравнение
            if (clientData.test_end_date.includes('T')) {
                return new Date().getTime() >= new Date(clientData.test_end_date).getTime();
            }

            // Для старого формата (только дата YYYY-MM-DD)
            const today = new Date();
            const testEndDate = new Date(clientData.test_end_date);
            testEndDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            return today.getTime() >= testEndDate.getTime();
        }
        
        // НОВАЯ ФУНКЦИЯ: Таймер обратного отсчета
        function startCountdownTimer(testEndDateString) {
            const timerEl = document.getElementById('testCountdownTimer');
            if (!timerEl) return;
            
            // Очищаем предыдущий интервал, если он был
            if (countdownTimerInterval) {
                clearInterval(countdownTimerInterval);
                countdownTimerInterval = null;
            }
            
            if (!testEndDateString || testEndDateString === "N/A" || !testEndDateString.includes('T')) {
                timerEl.classList.remove('active');
                timerEl.textContent = '';
                return;
            }
            
            const targetDate = new Date(testEndDateString);
            
            // Если дата истечения уже прошла (проверка с текущим временем, а не только с датой 00:00)
            if (new Date() >= targetDate) {
                 timerEl.classList.remove('active');
                 timerEl.textContent = 'Тест завершен!';
                 timerEl.style.color = 'var(--system-red)';
                 timerEl.style.borderColor = 'var(--system-red)';
                 timerEl.style.background = '#fff0f0';
                 return;
            }
            
            timerEl.classList.add('active'); // Показываем таймер
            timerEl.style.color = 'var(--system-orange)';
            timerEl.style.borderColor = 'var(--system-orange)';
            timerEl.style.background = '#fff8f0';
            
            countdownTimerInterval = setInterval(function() {
                const now = new Date().getTime();
                const distance = targetDate.getTime() - now;
                
                if (distance < 0) {
                    clearInterval(countdownTimerInterval);
                    countdownTimerInterval = null;
                    timerEl.textContent = "Тест завершен! Перезагрузите страницу.";
                    timerEl.style.color = 'var(--system-red)';
                    timerEl.style.borderColor = 'var(--system-red)';
                    timerEl.style.background = '#fff0f0';
                    document.getElementById('getTestBtn').disabled = true;
                    // Опционально: можно тут же вызвать openModal('expiredTestModal');
                    return;
                }
                
                // Расчет времени
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                // Форматирование
                const h = String(hours + days * 24).padStart(2, '0');
                const m = String(minutes).padStart(2, '0');
                const s = String(seconds).padStart(2, '0');
                
                timerEl.innerHTML = `До окончания теста: <span style="font-size: 1.2em;">${h}:${m}:${s}</span>`;
                
            }, 1000);
        }
        // КОНЕЦ НОВОЙ ФУНКЦИИ

        function extractPhoneNumber(phone) { return phone.replace(/\D/g, '').slice(-10); }
        
        // --- ИЗМЕНЕННАЯ ФУНКЦИЯ openModal ДЛЯ ДОБАВЛЕНИЯ ЗАКРЫТИЯ ПО КЛИКУ ВНЕ КОНТЕНТА ---
        function openModal(modalId) { 
             const modal = document.getElementById(modalId);
             if (!modal) return;
             
             const statusEl = document.getElementById(modalId === 'testPlaylistModal' ? 'testStatusMessage' : (modalId === 'loginModal' ? 'loginStatusMessage' : 'statusMessage'));
             if(statusEl) statusEl.style.display = 'none';

             modal.style.display = 'flex'; 
             modal.scrollTop = 0; 
             
             // Добавляем обработчик для закрытия при клике вне содержимого
             // Проверяем, что модалка не "channelModal" (там другая логика)
             if (modalId !== 'channelModal') {
                 modal.onclick = (event) => {
                     // Если клик был прямо по фону модалки (самому элементу .modal)
                     if (event.target === modal) {
                         closeModal(modalId);
                     }
                 };
             }
        }
        function closeModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none'; 
                modal.onclick = null; // Удаляем временный обработчик
            }
        }
        // ----------------------------------------------------------------------------------
        
        // НОВАЯ ФУНКЦИЯ: Всплывающее уведомление (Toast)
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Показать
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Скрыть и удалить
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                });
            }, 3000); 
        }

        // НОВЫЕ ФУНКЦИИ: Управление прелоадером
        function showLoader() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        function hideLoader() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showStatus(message, type, elementId = 'statusMessage') {
            const statusEl = document.getElementById(elementId);
            statusEl.innerHTML = message;
            statusEl.className = 'status-message ' + type;
            statusEl.style.display = 'block';
        }
        
        // ИЗМЕНЕНО: Замена alert на showToast
        function copyToClipboard(text, event) {
            if(event) event.preventDefault();
            navigator.clipboard.writeText(text).then(() => {
                showToast('Скопировано в буфер обмена: ' + text);
            }).catch(err => console.error('Ошибка копирования: ', err));
            return false;
        }
        function forceDownload(url, filename) {
            fetch(url).then(response => response.blob()).then(blob => {
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl; a.download = filename;
                document.body.appendChild(a); a.click();
                setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(blobUrl); }, 100);
            }).catch(error => console.error('Ошибка при скачивании файла:', error));
        }
        
        function logout() {
            currentClientData = null; currentPlaylistResult = null; currentTestPlaylistResult = null; 
            if (countdownTimerInterval) { // Очистка таймера при выходе
                clearInterval(countdownTimerInterval);
                countdownTimerInterval = null;
            }
            document.getElementById('testCountdownTimer').classList.remove('active'); // Скрываем таймер
            document.getElementById('testCountdownTimer').textContent = '';
            document.querySelector('.post-auth-layout').style.display = 'none';
            document.getElementById('preAuthContent').style.display = 'block';
            document.getElementById('howToConnectBlock').style.display = 'block';
            document.getElementById('whereItWorksBlock').style.display = 'block';
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.style.opacity = '0'; 
            setTimeout(() => {
                logoutBtn.style.display = 'none';
                ['regBtn', 'loginBtnNav'].forEach(id => {
                    const btn = document.getElementById(id);
                    btn.style.display = 'block';
                    btn.style.opacity = '1';
                });
            }, 300);
        }

        function showPlaylistPage() {
            ['preAuthContent', 'howToConnectBlock', 'whereItWorksBlock'].forEach(id => document.getElementById(id).style.display = 'none');
            document.querySelector('.post-auth-layout').style.display = 'flex';
            document.getElementById('playlistInfoPage').style.display = 'block';
            document.getElementById('paymentBlock').style.display = 'block';
            ['regBtn', 'loginBtnNav'].forEach(id => document.getElementById(id).style.display = 'none');
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.style.display = 'block';
            setTimeout(() => { logoutBtn.style.opacity = '1'; }, 100);
            
            document.getElementById('clientNameGreeting').textContent = `Привет, ${currentClientData.name || 'Клиент'}!`;
            document.getElementById('expirationMessage').textContent = `Ваш тариф ${getExpirationDays(currentClientData.paymentDate, currentClientData.months)}.`;
            
            // Логика отображения таймера
            const testBtn = document.getElementById('getTestBtn');
            const timerEl = document.getElementById('testCountdownTimer');
            
            // Сбрасываем предыдущий статус
            timerEl.classList.remove('active');
            timerEl.textContent = '';
            testBtn.disabled = false;
            // ИЗМЕНЕНИЕ: Всегда устанавливаем текст кнопки на "Взять тест"
            testBtn.textContent = 'Взять тест'; 

            if (currentClientData.test_end_date && currentClientData.test_end_date !== "N/A") {
                
                // Проверяем, есть ли время в строке (формат ISO с 'T')
                if (currentClientData.test_end_date.includes('T')) {
                    // Если есть полное время, запускаем таймер
                    startCountdownTimer(currentClientData.test_end_date);
                    // Деактивируем кнопку, если тест истек (проверяем уже по текущему времени)
                    if (isTestExpired(currentClientData)) {
                         testBtn.disabled = true;
                    }
                } else {
                    // Старый формат YYYY-MM-DD (только дата)
                    if (isTestExpired(currentClientData)) {
                        timerEl.textContent = 'Тест завершен!';
                        timerEl.classList.add('active'); 
                        timerEl.style.color = 'var(--system-red)';
                        timerEl.style.borderColor = 'var(--system-red)';
                        timerEl.style.background = '#fff0f0';
                        testBtn.disabled = true;
                    } else {
                        // Тест активен, но без точного времени (старый формат). Показываем сообщение.
                        timerEl.textContent = 'Тестовый период активен.';
                        timerEl.classList.add('active'); 
                        timerEl.style.color = 'var(--system-green)';
                        timerEl.style.borderColor = 'var(--system-green)';
                        timerEl.style.background = '#f0fff0';
                        testBtn.disabled = false;
                    }
                }
            } else {
                // Если тест не брали или N/A
                testBtn.disabled = false;
            }
            
            // Здесь отображаем короткую ссылку
            document.getElementById('finalPlaylistLink').textContent = currentPlaylistResult.isgdUrl;
            
            // КНОПКА КОПИРОВАТЬ: Копирует короткую ссылку
            document.getElementById('copyLinkBtnPage').onclick = (e) => copyToClipboard(currentPlaylistResult.isgdUrl, e);
            
            // КНОПКА СКАЧАТЬ: Создаем прямую ссылку на СТАТИЧЕСКИЙ файл ОСНОВНОГО плейлиста для скачивания
            const downloadUrl = `${REPO_CONFIG.baseUrl}${currentClientData.phone}.m3u`;
            document.getElementById('downloadLinkBtnPage').onclick = () => {
                window.open(downloadUrl, '_blank'); 
            };
        }

        async function getFileSha(filename) {
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`;
            try {
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Accept': 'application/vnd.github+json' } });
                if (response.ok) return (await response.json()).sha;
                if (response.status === 404) return null;
                throw new Error(`Ошибка при получении SHA: ${response.statusText}`);
            } catch (error) { console.error('Ошибка при получении SHA:', error); return null; }
        }

        async function loadClientsFromGitHub() {
            const apiUrl = `https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`;
            const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Accept': 'application/vnd.github.v3+json' } });
            if (response.ok) {
                const data = await response.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                return { clients: JSON.parse(content) || [], sha: data.sha };
            }
            if (response.status === 404) return { clients: [], sha: null };
            throw new Error(`Ошибка загрузки: ${response.statusText}`);
        }

        async function updateClientData(client) {
            let { clients: currentClients, sha } = await loadClientsFromGitHub();
            const index = currentClients.findIndex(c => c.phone === client.phone);
            if (index === -1) throw new Error("Клиент не найден.");
            
            // Обновляем данные клиента
            currentClients[index] = client;
            
            const response = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `Обновлены данные клиента: ${client.name} (тест)`, content: btoa(unescape(encodeURIComponent(JSON.stringify(currentClients)))), branch: REPO_CONFIG.branch, sha: sha })
            });
            if (!response.ok) throw new Error((await response.json()).message || "Ошибка при сохранении данных клиента.");
            return true;
        }

        // =================================================================
        // ФУНКЦИЯ: Создание короткой ссылки
        // =================================================================
        async function createIsGdShortUrl(phone, isTest = false) {
            const cleanPhone = extractPhoneNumber(phone);
            const shortUrlAlias = isTest ? `test${cleanPhone}` : cleanPhone;
            
            const longUrl = isTest 
                            // Для тестового используем Netlify Function
                            ? `${REPO_CONFIG.baseUrl}api/playlist_link?phone=${cleanPhone}`
                            // Для платного используем статическую ссылку
                            : `${REPO_CONFIG.baseUrl}${cleanPhone}.m3u`;
            
            try {
                const apiUrl = `https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}&shorturl=${shortUrlAlias}`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                return data.errorcode ? `https://is.gd/${shortUrlAlias}` : data.shorturl;
            } catch (error) { 
                console.error('Ошибка создания is.gd ссылки:', error); 
                return `https://is.gd/${shortUrlAlias}`;
            }
        }
        // =================================================================

        // =================================================================
        // ФУНКЦИЯ: Создание тестового плейлиста (test{phone}.m3u)
        // =================================================================
        async function createTestPlaylist(phone) {
            const cleanPhone = extractPhoneNumber(phone);
            const filename = `public/test${cleanPhone}.m3u`;
            const key = '0000000000'; 
            
            // Использует редирект /sample.m3u
            const response = await fetch(REPO_CONFIG.samplePlaylist);
            if (!response.ok) throw new Error("Не удалось загрузить образец плейлиста sample.m3u.");
            
            let content = await response.text();
            content = content.replace(/\/iptv\/\w+\//g, `/iptv/${key}/`);
            
            const sha = await getFileSha(filename);
            const uploadResponse = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `Обновление ТЕСТОВОГО плейлиста: ${cleanPhone}`, content: btoa(unescape(encodeURIComponent(content))), branch: REPO_CONFIG.branch, sha: sha })
            });
            
            if (!uploadResponse.ok) throw new Error((await response.json()).message || "Ошибка при загрузке тестового плейлиста");
            
            const isgdUrl = await createIsGdShortUrl(phone, true); 
            return { isgdUrl, m3uFilename: `test${cleanPhone}.m3u`, m3uContent: content };
        }
        // =================================================================

        async function createPlaylist(phone, key) {
            const cleanPhone = extractPhoneNumber(phone);
            if (cleanPhone.length < 10) throw new Error("Номер должен содержать минимум 10 цифр.");
            
            const filename = `public/${cleanPhone}.m3u`;
            // Использует редирект /sample.m3u
            const response = await fetch(REPO_CONFIG.samplePlaylist);
            if (!response.ok) throw new Error("Не удалось загрузить образец плейлиста sample.m3u.");
            
            let content = await response.text();
            content = content.replace(/\/iptv\/\w+\//g, `/iptv/${key}/`);
            
            const sha = await getFileSha(filename);
            const uploadResponse = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${filename}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `Обновление плейлиста: ${cleanPhone}`, content: btoa(unescape(encodeURIComponent(content))), branch: REPO_CONFIG.branch, sha: sha })
            });
            
            if (!uploadResponse.ok) throw new Error((await response.json()).message || "Ошибка при загрузке плейлиста");
            
            const isgdUrl = await createIsGdShortUrl(phone, false); 
            return { isgdUrl, m3uFilename: `${cleanPhone}.m3u`, m3uContent: content };
        }
        
        async function sendRegistrationToTelegram(clientData) {
            const regDate = new Date(clientData.registration_date).toLocaleDateString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            const message = `🔔 НОВАЯ РЕГИСТРАЦИЯ! 🔔\n\nИмя: ${clientData.name}\nТелефон: ${clientData.phone}\nДата: ${regDate}`;
            const apiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}&parse_mode=HTML`;
            
            try {
                await fetch(apiUrl, { method: 'POST' });
            } catch (error) {
                console.error('Ошибка при отправке в Telegram:', error);
            }
        }

        async function saveClientData(client) {
            let { clients: currentClients, sha } = await loadClientsFromGitHub();
            if (currentClients.some(c => c.phone === client.phone)) throw new Error("Клиент с таким номером уже зарегистрирован.");
            currentClients.push(client);
            const response = await fetch(`https://api.github.com/repos/${REPO_CONFIG.owner}/${REPO_CONFIG.repo}/contents/${REPO_CONFIG.clientsFile}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${getGitHubToken()}`, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github+json' },
                body: JSON.stringify({ message: `Добавлен новый клиент: ${client.name}`, content: btoa(unescape(encodeURIComponent(JSON.stringify(currentClients)))), branch: REPO_CONFIG.branch, sha: sha })
            });
            if (!response.ok) throw new Error((await response.json()).message || "Ошибка при сохранении данных клиента.");
            return true;
        }
        
        async function handleTestBtnClick() {
            if (!currentClientData) {
                showToast('Сначала войдите в систему.');
                return;
            }
            
            // Проверка истечения с учетом точного времени
            if (currentClientData.test_end_date && currentClientData.test_end_date.includes('T') && new Date().getTime() >= new Date(currentClientData.test_end_date).getTime()) {
                openModal('expiredTestModal');
                return;
            }
            
            try {
                showLoader(); // Показать прелоадер
                
                const isNewTestOrExpired = !currentClientData.test_end_date || currentClientData.test_end_date === "N/A" || isTestExpired(currentClientData);
                
                if (isNewTestOrExpired) {
                    const today = new Date();
                    // Устанавливаем тестовый период в 24 часа (1 день) с текущим временем
                    const endDate = new Date(today.getTime() + (24 * 60 * 60 * 1000)); 
                    currentClientData.test_end_date = endDate.toISOString(); // Сохраняем ISO-строку с временем
                    
                    // Обновляем данные на GitHub
                    await updateClientData(currentClientData);
                    
                    // После успешного обновления и запускаем таймер
                    startCountdownTimer(currentClientData.test_end_date);
                    // ИЗМЕНЕНИЕ: Убран текст "Обновить тест-плейлист"
                }
                
                currentTestPlaylistResult = await createTestPlaylist(currentClientData.phone);
                
                const linkBox = document.getElementById('testPlaylistLinkBox');
                const goToBtn = document.getElementById('goToTestLinkBtn'); 
                
                linkBox.textContent = currentTestPlaylistResult.isgdUrl;
                
                // Назначаем действие копирования на сам блок текста
                linkBox.onclick = () => copyToClipboard(linkBox.textContent); 

                // Назначаем действие кнопке "Перейти"
                goToBtn.onclick = () => window.open(currentTestPlaylistResult.isgdUrl, '_blank'); 

                document.getElementById('testStatusMessage').style.display = 'none';
                
                hideLoader(); // Скрыть прелоадер
                openModal('testPlaylistModal');
                
            } catch (error) {
                hideLoader(); // Скрыть прелоадер при ошибке
                showStatus(`❌ Ошибка создания тестового плейлиста: ${error.message}`, "error", 'testStatusMessage');
                console.error('Ошибка создания тестового плейлиста:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            window.handleTestBtnClick = handleTestBtnClick; // Добавляем функцию в глобальный scope
            
            document.getElementById('registrationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('clientName').value.trim();
                const phone = document.getElementById('clientPhone').value.trim();
                const password = document.getElementById('clientPassword').value;
                const passwordRepeat = document.getElementById('clientPasswordRepeat').value;
                const cleanPhoneDigits = extractPhoneNumber(phone);
                
                if (!name || !phone || !password || password !== passwordRepeat || password.length < 6 || cleanPhoneDigits.length < 10) {
                    showStatus("Проверьте поля: заполнены, пароли совпадают (мин. 6 симв.), телефон (мин. 10 цифр).", "error");
                    return;
                }

                showLoader(); // Показать прелоадер

                // Изначально test_end_date не установлен
                const newClient = { name, phone: cleanPhoneDigits, password, key: '0000000000', paymentDate: new Date().toISOString().split('T')[0], months: '1', registration_date: new Date().toISOString(), test_end_date: "N/A" }; 
                try {
                    await sendRegistrationToTelegram(newClient);
                    
                    currentPlaylistResult = await createPlaylist(phone, newClient.key);
                    await saveClientData(newClient);
                    currentClientData = newClient;
                    
                    document.getElementById('registrationForm').reset();
                    closeModal('registrationModal');
                    
                    hideLoader(); // Скрыть прелоадер
                    
                    // --- ВОССТАНОВЛЕНО: Открываем модалку входа после регистрации ---
                    document.getElementById('loginPhone').value = phone; 
                    document.getElementById('loginPassword').value = password; 
                    openModal('loginModal');
                    // -----------------------------------------------------------

                } catch (error) { 
                    hideLoader(); // Скрыть прелоадер при ошибке
                    showStatus(`❌ Ошибка: ${error.message}`, "error"); 
                    console.error('Ошибка регистрации:', error); 
                }
            });

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const loginPhone = document.getElementById('loginPhone').value.trim();
                const loginPassword = document.getElementById('loginPassword').value;
                const cleanLoginPhoneDigits = extractPhoneNumber(loginPhone);
                if (!loginPhone || !loginPassword) { showStatus('Заполните все поля.', "error", 'loginStatusMessage'); return; }
                
                showLoader(); // Показать прелоадер

                try {
                    const { clients } = await loadClientsFromGitHub();
                    const client = clients.find(c => c.phone === cleanLoginPhoneDigits && c.password === loginPassword);
                    if (client) {
                        // Если в старых данных нет test_end_date, добавляем "N/A"
                        if (!client.test_end_date) client.test_end_date = "N/A";
                        
                        currentClientData = client;
                        currentPlaylistResult = await createPlaylist(loginPhone, client.key || '0000000000');
                        closeModal('loginModal');
                        showPlaylistPage();
                        
                        hideLoader(); // Скрыть прелоадер
                    } else { 
                        hideLoader(); // Скрыть прелоадер при ошибке
                        showStatus('Неверный номер или пароль.', "error", 'loginStatusMessage'); 
                    }
                } catch (error) { 
                    hideLoader(); // Скрыть прелоадер при ошибке
                    showStatus(`❌ Ошибка входа: ${error.message}`, "error", 'loginStatusMessage'); 
                    console.error('Ошибка входа:', error); 
                }
            });
            
            // --- УДАЛЕНА ЛОГИКА ПЕРЕКЛЮЧЕНИЯ НА ВНУТРЕННЮЮ СТРАНИЦУ СПИСКА КАНАЛОВ ---
            /*
            document.getElementById('showChannelListBtn').addEventListener('click', function() {
                document.getElementById('mainPageContent').style.display = 'none';
                document.getElementById('channelListPage').style.display = 'block';
                document.getElementById('authButtonsContainer').style.display = 'none';
                document.querySelector('.admin-button-container').style.display = 'none';
            });
            */
        });

        window.openModal = openModal;
        window.closeModal = closeModal;
        window.logout = logout;
    </script>
    
    <script>
        // =================================================================
        // СКРИПТ ДЛЯ СТРАНИЦЫ СПИСКА КАНАЛОВ (теперь не используется для перехода)
        // =================================================================
        // Код оставлен для случая, если пользователь захочет вернуть внутреннюю логику
        (function() {
            const url = `${BASE_URL}moe.m3u`;
            const categoriesEl = document.getElementById('categories');
            const searchResultsEl = document.getElementById('search-results');
            const channelModal = document.getElementById('channelModal');
            const modalTitle = document.getElementById('modal-title');
            const channelList = document.getElementById('channel-list');
            const mainSearch = document.getElementById('main-search');
            const modalSearch = document.getElementById('modal-search');

            let dataByGroup = {};
            let allChannels = [];
            let allCategories = [];

            window.closeChannelModal = function() {
                channelModal.style.display = 'none';
            }

            async function fetchAndParseM3U() {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const text = await res.text();
                    const lines = text.split('\n');
                    let currentInfo = '';
                    let currentGroup = 'Без категории';

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('#EXTINF')) { currentInfo = line; } 
                        else if (line.startsWith('#EXTGRP')) { currentGroup = line.replace('#EXTGRP:', '').trim(); } 
                        else if (line && !line.startsWith('#')) {
                            const titleMatch = currentInfo.match(/,(.*)$/);
                            const title = titleMatch ? titleMatch[1] : 'Неизвестный канал';
                            if (!dataByGroup[currentGroup]) dataByGroup[currentGroup] = [];
                            const channelData = { title, group: currentGroup, url: line };
                            dataByGroup[currentGroup].push(channelData);
                            allChannels.push(channelData);
                            currentGroup = 'Без категории'; // Reset group for next entry
                        }
                    }
                    allCategories = Object.keys(dataByGroup).sort();
                    // renderCategories(); // Не вызываем, так как страница не отображается
                } catch (error) {
                    console.error("Failed to fetch and parse M3U file:", error);
                    // categoriesEl.innerHTML = "<p>Не удалось загрузить список каналов. Попробуйте позже.</p>"; // Не отображаем
                }
            }

            function renderCategories() {
                categoriesEl.innerHTML = '';
                searchResultsEl.innerHTML = '';
                categoriesEl.style.display = 'grid';
                allCategories.forEach(group => {
                    const count = dataByGroup[group].length;
                    const el = document.createElement('div');
                    el.className = 'category';
                    el.innerHTML = `<div class="category-name">${group}</div><div class="category-count">Каналов: ${count}</div>`;
                    el.onclick = () => openChannelModal(group);
                    categoriesEl.appendChild(el);
                });
            }

            function openChannelModal(group) {
                modalTitle.textContent = group;
                channelList.innerHTML = '';
                dataByGroup[group].forEach(channel => {
                    const ch = document.createElement('div');
                    ch.className = 'channel';
                    ch.textContent = channel.title;
                    channelList.appendChild(ch);
                });
                channelModal.style.display = 'flex';
                modalSearch.value = '';
                modalSearch.focus();
                modalSearch.oninput = function() {
                    const searchTerm = this.value.toLowerCase();
                    channelList.querySelectorAll('.channel').forEach(channel => {
                        channel.style.display = channel.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
                    });
                };
            }

            // fetchAndParseM3U(); // Удален вызов загрузки при старте DOM
        })();
    </script>
</body>
</html>